name: Parse RustMaps

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: false

on:
  schedule:          # –∫–∞–∂–¥—ã–µ 15 –º–∏–Ω
    - cron: '0 8 * * *' 
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'src/**'
      - 'package.json'
      - '.github/workflows/parse-maps.yml'

jobs:
  parse-maps:
    runs-on: ubuntu-latest
    permissions:
      contents: write        # –Ω—É–∂–µ–Ω push

    steps:
    #--- –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ ----------------------------------------------------------
    - uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0        # –∏–Ω–∞—á–µ push –º–æ–∂–µ—Ç —É–ø–∞—Å—Ç—å

    - uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install system dependencies
      run: |
        sudo apt-get update -qq
        sudo apt-get install -y --no-install-recommends \
          libnss3 libatk-bridge2.0-0 libdrm2 libxkbcommon0 libxcomposite1 \
          libxdamage1 libxrandr2 libgbm1 libxss1 libasound2t64 libgtk-3-0

    - name: Install npm deps (3 –ø–æ–ø—ã—Ç–∫–∏)
      run: |
        for i in {1..3}; do
          echo "npm ci attempt #$i"
          npm ci --prefer-offline --no-audit && break
          [[ $i == 3 ]] && exit 1
          sleep 10
        done

    - name: Build project
      run: npm run build

    #--- –∑–∞–ø—É—Å–∫ –ø–∞—Ä—Å–µ—Ä–∞ —Ä–æ–≤–Ω–æ 600 —Å -----------------------------------------
    - name: Parse maps (stop at 6000 s)
      env:
        DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        FACEPUNCH_UPLOAD_ENABLED: 'true'
      run: |
        set +e                         # –Ω–µ –∑–∞–≤–µ—Ä—à–∞–µ–º job –ø—Ä–∏ exit 124
        timeout 6000 npm start scan
        code=$?
        if [ $code -eq 124 ]; then     # 124 ‚Üí –≤—Ä–µ–º—è –≤—ã—à–ª–æ, —ç—Ç–æ ¬´—É—Å–ø–µ—Ö¬ª
          echo "Parser stopped after 6000 s as intended."
          code=0
        fi
        exit $code

    #--- —Ñ–∏–∫—Å–∞—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ -----------------------------------------------
    - name: Detect changes
      id: changes
      if: always()                     # –¥–∞–∂–µ –ø–æ—Å–ª–µ —Ç–∞–π–º-–∞—É—Ç–∞
      run: |
        git add -A output/
        if git diff --cached --quiet; then
          echo "changed=false" >> "$GITHUB_OUTPUT"
        else
          echo "changed=true"  >> "$GITHUB_OUTPUT"
        fi

    - name: Commit & push
      if: steps.changes.outputs.changed == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name  "GitHub Action"
        git commit -m "ü§ñ Update rustmaps cache $(date -u '+%Y-%m-%d %H:%M:%S UTC')" || true
        git pull --rebase --autostash      # –∑–∞—â–∏—Ç–∏–º—Å—è –æ—Ç –≥–æ–Ω–∫–∏ —Å–æ —Å–ª–µ–¥—É—é—â–∏–º –∑–∞–ø—É—Å–∫–æ–º
        git push

    #--- –∞—Ä—Ç–µ—Ñ–∞–∫—Ç ------------------------------------------------------------
    - uses: actions/upload-artifact@v4
      if: always()
      with:
        name: rustmaps-cache
        path: output/rustmaps-cache.json
        retention-days: 30
